name: Deploy Nomad Config
on: [push]

env:
  NOMAD_ADDR: ${{ secrets.NOMAD_ADDR }}
  NOMAD_TOKEN: ${{ secrets.NOMAD_TOKEN }}

jobs:
  ansible:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code 
        uses: actions/checkout@v4
      - name: Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TS_AUTHKEY }}

      - name: Write Out Ansible Vault Password
        uses: DamianReeves/write-file-action@master
        with:
          path: ansible.vault
          contents: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}

      - name: Fix rsync
        run: mkdir -p conf/nomad

      - name: Run Ansible Playbook
        uses: dawidd6/action-ansible-playbook@v2
        with:
          playbook: ansible/playbook.yaml
          key: ${{ secrets.ANSIBLE_SSH_PRIVATE_KEY }}
          inventory: |
            [main]
            10.0.0.1
            10.0.0.3
            10.0.0.5
          options: |
            -e @static_keys.yaml
            --vault-password-file ansible.vault
            
  nomad:
    needs: ansible
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code 
        uses: actions/checkout@v4
      - name: Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TS_AUTHKEY }}
      - name: Setup Nomad
        uses: lucasmelin/setup-nomad@v2.0.0
      - run: nomad volume register volumes/nfs-grafana.hcl
      - run: nomad volume register volumes/nfs-influxdb.hcl
      - run: nomad volume register volumes/nfs-prometheus.hcl
      - run: nomad volume register volumes/nfs-hoass.hcl
      - run: nomad volume register volumes/nfs-seaweedfs.hcl
      - run: nomad volume register volumes/nfs-keepass-store.hcl
      - run: nomad volume register volumes/nfs-ytdl.hcl
      - run: nomad run jobs/network.hcl
      - run: nomad run jobs/plugins/nfs_csi_nodes.hcl
      - run: nomad run jobs/plugins/nfs_csi_controller.hcl
      - run: nomad run jobs/homeassistant.hcl
      - run: nomad run jobs/headscale.hcl
      - run: nomad run jobs/samba.hcl
      - run: nomad run jobs/traefik.hcl
      - run: nomad run jobs/cloudflared.hcl
      - run: nomad run jobs/monitor.hcl
      - run: nomad run jobs/metube.hcl
